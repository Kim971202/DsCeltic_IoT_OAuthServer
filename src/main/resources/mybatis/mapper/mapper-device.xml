<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oauth.mapper.DeviceMapper">

    <resultMap id="device" type="com.oauth.dto.AuthServerDTO"> </resultMap>
    <resultMap id="dr910w" type="com.oauth.dto.gw.DeviceStatusInfo$Device"> </resultMap>
    <resultMap id="String" type="String"> </resultMap>

    <select id="getDeviceInfoSearchIdx" parameterType="java.util.List" resultMap="device">
        SELECT DISTINCT
            device.DEVC_MODL_CD AS modelCode,
            device.ATTC_ID AS controlAuthKey,
            device.DEVC_ID AS deviceId,
            regist.DEVC_NICK AS deviceNickname,
            regist.ZIP AS zipCode,
            regist.OLD_ADDR AS oldAddr,
            regist.NEW_ADDR AS newAddr,
            regist.DTAIL_ADDR AS addrDetail,
            regist.LAT AS latitude,
            regist.LON AS longitude,
            regist.TEMP_DEVC_REG_KEY AS tmpRegistKey,
            regist.GRP_IDX AS groupIdx,
            regist.GRP_NM AS groupName,
            regist.USER_ID AS userId
        FROM
            TBR_IOT_DEVICE AS device
        INNER JOIN
            TBT_OPR_DEVICE_REGIST AS regist
        ON
            device.DEVC_ID = regist.DEVC_ID
        INNER JOIN
            TBD_USER_INVITE_GROUP AS invite
        ON
            regist.GRP_IDX = invite.GRP_IDX
        WHERE
            invite.GRP_IDX IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND
            regist.VALVE_STATUS = 'N'
    </select>

    <select id="getDeviceInfoSearchIdxTemp" parameterType="java.util.List" resultMap="device">
        SELECT DISTINCT
            device.DEVC_MODL_CD AS modelCode,
            device.ATTC_ID AS controlAuthKey,
            device.DEVC_ID AS deviceId,
            regist.DEVC_NICK AS deviceNickname,
            regist.ZIP AS zipCode,
            regist.OLD_ADDR AS oldAddr,
            regist.NEW_ADDR AS newAddr,
            regist.DTAIL_ADDR AS addrDetail,
            regist.LAT AS latitude,
            regist.LON AS longitude,
            regist.TEMP_DEVC_REG_KEY AS tmpRegistKey,
            regist.GRP_IDX AS groupIdx,
            regist.GRP_NM AS groupName,
            regist.USER_ID AS userId
        FROM
            TBR_IOT_DEVICE AS device
        INNER JOIN
            TBT_OPR_DEVICE_REGIST AS regist
        ON
            device.DEVC_ID = regist.DEVC_ID
        INNER JOIN
            TBD_USER_INVITE_GROUP AS invite
        ON
            regist.GRP_IDX = invite.GRP_IDX
        WHERE
            invite.GRP_IDX IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getDeviceInfoSearchList" parameterType="java.util.List" resultMap="device">
        SELECT
        device.DEVC_MODL_CD AS modelCode,
        device.ATTC_ID AS controlAuthKey,
        device.DEVC_ID AS deviceId,
        regist.DEVC_NICK AS deviceNickname,
        regist.ZIP AS zipCode,
        regist.OLD_ADDR AS oldAddr,
        regist.NEW_ADDR AS newAddr,
        regist.DTAIL_ADDR AS addrDetail,
        regist.LAT AS latitude,
        regist.LON AS longitude,
        regist.TEMP_DEVC_REG_KEY AS tmpRegistKey,
        regist.GRP_IDX AS groupIdx,
        regist.GRP_NM AS groupName,
        regist.USER_ID AS userId,
        ROW_NUMBER() OVER () AS regSort
        FROM
        TBR_IOT_DEVICE AS device
        INNER JOIN
        TBT_OPR_DEVICE_REGIST AS regist
        ON
        device.DEVC_ID = regist.DEVC_ID
        INNER JOIN
        WHERE
            regist.USER_ID IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.groupId}
        </foreach>
    </select>

    <select id="getSingleSerialNumberBydeviceId" parameterType="String" resultMap="device">
        SELECT
            SERIAL_NO AS serialNumber
        FROM
            TBR_IOT_DEVICE
        WHERE
            DEVC_ID = #{deviceId}
    </select>

    <select id="getMultiSerialNumberBydeviceId" parameterType="hashmap" resultMap="device">
        SELECT
            SERIAL_NO AS serialNumber,
            DEVC_MODL_CD AS modelCode
        FROM
            TBR_IOT_DEVICE
        WHERE
            DEVC_ID IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.deviceId}
        </foreach>
    </select>

    <select id="getDeviceAuthCheckValuesByUserId" parameterType="String" resultMap="device">
        SELECT
            DEVC_ID AS deviceId,
            DEVC_CTRL_KEY AS controlAuthKey
        FROM
            TBR_OPR_USER_DEVICE
        WHERE
            USER_ID = #{userId}
    </select>

    <select id="deviceAuthCheck" parameterType="hashmap" resultMap="device">
        SELECT
            DEVC_ID AS deviceId,
            DEVC_CTRL_KEY AS controlAuthKey,
            DEVC_NICK AS deviceNickname
        FROM
            TBR_OPR_DEVICE_DETAIL
        WHERE
            <foreach collection="list" item="item" separator=" OR " open="(" close=")">
                DEVC_ID = #{item.deviceId} AND DEVC_CTRL_KEY = #{item.controlAuthKey}
            </foreach>
    </select>

    <select id="deviceTempAuthCheck" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            *
        FROM
            TBR_OPR_DEVICE_DETAIL
        WHERE
            TEMP_DEVC_REG_KEY = #{controlAuthKey}
        AND
            DEVC_ID = #{deviceId}
        AND
            HP = #{hp}
        AND
            USER_ID = #{userId}
    </select>

    <update id="changeDeviceNickname" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBR_OPR_DEVICE_DETAIL
        SET
            DEVC_NICK = #{newDeviceNickname}
        WHERE
            DEVC_ID = #{deviceId}
    </update>

    <update id="changeEachRoomDeviceNickname" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBR_OPR_VALVE_BOX_STATUS
        SET
            DV_NM = #{newDeviceNickname}
        WHERE
            SUB_ID = #{deviceId}
    </update>

    <insert id="insertDeviceModelCode" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO TBD_IOT_DEVICE_MODL_CD
            (
                DEVC_MODL_CD,
                DEVC_MODL_NM,
                MENUFACTORY_NM,
                DEVC_TYPE_CD,
                REG_DATM,
                MENUFACTORY_CD
            )
        VALUES
            (
                #{modelCode},
                'BOILER',
                'DSCeltic',
                #{deviceType},
                now(),
                'DS'
            )
    </insert>

    <insert id="insertDeviceGrpInfo" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_IOT_DEVICE_GRP_INFO
            (
                DEVC_ID,
                GRP_ID
            )
            VALUES
            (
                #{deviceId},
                #{userId}
            )
    </insert>

    <insert id="insertDeviceGrpInfoByList" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_IOT_DEVICE_GRP_INFO
            (
                DEVC_ID,
                GRP_ID
            )
            VALUES
            <foreach collection="list" item="item" separator=",">
            (
                #{item.deviceId},
                #{item.userId}
            )
        </foreach>
    </insert>

    <insert id="insertDeviceListGrpInfo" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_IOT_DEVICE_GRP_INFO
        (
            DEVC_ID,
            GRP_ID
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.deviceId},
                #{item.userId}
            )
        </foreach>
    </insert>

    <delete id="deleteDeviceListGrpInfo" parameterType="list">
        DELETE FROM
            TBR_IOT_DEVICE_GRP_INFO
        WHERE
        <foreach collection="list" item="item" separator=" OR ">
            (DEVC_ID = #{item.deviceId} AND GRP_ID = #{item.userId})
        </foreach>
    </delete>

    <insert id="insertDevice" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO TBR_IOT_DEVICE
            (
                DEVC_ID,
                DEVC_MODL_CD,
                SERIAL_NO,
                ATTC_ID,
                DEVC_LAT,
                DEVC_LON,
                DEVC_STAT_CD,
                REG_DATAM,
                LAST_CONN_DATM,
                LSAT_FAULT_DATM
            )
        VALUES
            (
                #{deviceId},
                #{modelCode},
                #{serialNumber},
                #{controlAuthKey},
                #{latitude},
                #{longitude},
                '01',
                now(),
                now(),
                now()
            )
    </insert>

    <insert id="insertDeviceRegist" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO TBT_OPR_DEVICE_REGIST
            (
                TEMP_DEVC_REG_KEY,
                DEVC_ID,
                HP,
                USER_ID,
                ZIP,
                OLD_ADDR,
                NEW_ADDR,
                DTAIL_ADDR,
                LAT,
                LON,
                DEVC_NICK,
                REG_DATM,
                GRP_IDX,
                GRP_NM,
                VALVE_STATUS
            )
        VALUES
            (
                #{tmpRegistKey},
                #{deviceId},
                #{hp},
                #{userId},
                #{zipCode},
                #{oldAddr},
                #{newAddr},
                #{addrDetail},
                #{latitude},
                #{longitude},
                #{deviceNickname},
                now(),
                #{idx},
                #{groupName},
                #{valveStatus}
            )
    </insert>

    <update id="updateDeviceRegist" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBT_OPR_DEVICE_REGIST
        SET
            ZIP = #{zipCode},
            OLD_ADDR = #{oldAddr},
            NEW_ADDR = #{newAddr},
            DTAIL_ADDR = #{addrDetail},
            LAT = #{latitude},
            LON = #{longitude},
            DEVC_NICK = #{deviceNickname},
            REG_DATM = now()
        WHERE
            DEVC_ID = #{deviceId}
        AND
            HP = #{hp}
        AND
            USER_ID = #{userId}
    </update>

    <insert id="insertDeviceDetail" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO TBR_OPR_DEVICE_DETAIL
            (
                DEVC_ID,
                DEVC_CTRL_KEY,
                ZIP,
                OLD_ADDR,
                NEW_ADDR,
                DTAIL_ADDR,
                DEVC_STAT_JSON,
                DEVC_NICK,
                DEVC_REG_DATM,
                GRP_IDX
            )
        VALUES
            (
                #{deviceId},
                #{controlAuthKey},
                #{zipCode},
                #{oldAddr},
                #{newAddr},
                #{addrDetail},
                'empty',
                #{deviceNickname},
                now(),
                #{idx}
            )
    </insert>

    <update id="updateDeviceDetail" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_DEVICE_DETAIL
        SET
            DEVC_CTRL_KEY = #{newControlAuthKey},
            ZIP = #{zipCode},
            OLD_ADDR = #{oldAddr},
            NEW_ADDR = #{newAddr},
            DTAIL_ADDR = #{addrDetail},
            DEVC_NICK = #{deviceNickname},
            DEVC_REG_DATM = now()
        WHERE
            DEVC_CTRL_KEY = #{controlAuthKey}
        AND
            DEVC_ID = #{deviceId}
    </update>

    <update id="changeDeviceNicknameTemp" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBT_OPR_DEVICE_REGIST
        SET
            DEVC_NICK = #{deviceNickname}
        WHERE
            DEVC_ID = #{deviceId}
    </update>

    <update id="updateGroupName" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBD_USER_INVITE_GROUP
        SET
            GRP_NM = #{groupName}
        WHERE
            GRP_IDX = #{groupIdx}
    </update>

    <update id="updateDeviceRegistLocation" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBT_OPR_DEVICE_REGIST
        SET
            ZIP = #{zipCode},
            OLD_ADDR = #{oldAddr},
            NEW_ADDR = #{newAddr},
            DTAIL_ADDR = #{addrDetail},
            LAT = #{latitude},
            LON = #{longitude},
            DEVC_NICK = #{deviceNickname}
        WHERE
            TEMP_DEVC_REG_KEY = #{tmpRegistKey}
        AND
            DEVC_ID = #{deviceId}
    </update>

    <update id="updateDeviceRegistGroupName" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBT_OPR_DEVICE_REGIST
        SET
            GRP_NM = #{groupName}
        WHERE
            GRP_IDX = #{groupIdx}
    </update>

    <update id="updateDeviceDetailLocation" parameterType="com.oauth.dto.AuthServerDTO">
        UPDATE
            TBR_OPR_DEVICE_DETAIL
        SET
            ZIP = #{zipCode},
            OLD_ADDR = #{oldAddr},
            NEW_ADDR = #{newAddr},
            DTAIL_ADDR = #{addrDetail},
            DEVC_NICK = #{deviceNickname}
        WHERE
            DEVC_ID = #{deviceId}
    </update>

    <select id="getControlAuthKeyByUserId" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            a.DEVC_CTRL_KEY AS controlAuthKey,
            a.DEVC_ID AS deviceId,
            a.USER_ID AS userId,
            b.GRP_IDX AS groupIdx,
            b.GRP_NM AS groupName,
            b.VALVE_STATUS AS valveStatus
        FROM
            TBR_OPR_USER_DEVICE a
        INNER JOIN
            TBT_OPR_DEVICE_REGIST b
        ON
            a.DEVC_ID = b.DEVC_ID
        WHERE
            a.USER_ID = #{groupId}
        AND
            a.GRP_IDX = #{groupIdx}
        AND 
            b.VALVE_STATUS = 'N'
    </select>

    <select id="getDeviceNicknameAndDeviceLocNickname" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            DEVC_NICK AS deviceNickname,
            DEVC_ID AS deviceId,
            LAT AS latitude,
            LON AS longitude,
            TEMP_DEVC_REG_KEY AS tmpRegistKey,
            ROW_NUMBER() OVER () AS regSort
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            DEVC_ID IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.deviceId}
        </foreach>
        AND
            USER_ID IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.userId}
        </foreach>
        ORDER BY DEVC_ID
    </select>

    <select id="getDeviceInfoSearch" parameterType="String" resultMap="device">
        SELECT
            device.DEVC_MODL_CD AS modelCode,
            regist.DEVC_NICK AS deviceNickname,
            regist.ZIP AS zipCode,
            regist.OLD_ADDR AS oldAddr,
            regist.NEW_ADDR AS newAddr,
            regist.DTAIL_ADDR AS addrDetail,
            regist.LAT AS latitude,
            regist.LON AS longitude,
            regist.GRP_IDX AS groupIdx,
            regist.GRP_NM AS groupName
        FROM
            TBR_IOT_DEVICE AS device
        INNER JOIN
            TBT_OPR_DEVICE_REGIST AS regist
        ON
            device.DEVC_ID = regist.DEVC_ID
        WHERE
            device.DEVC_ID =  #{deviceId}
    </select>

   <insert id="insertEachRoomStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        INSERT INTO TBR_OPR_VALVE_BOX_STATUS
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">SUB_ID,</if>
            <if test="serialNumber != null">SERIAL_NO,</if>
            <if test="modelCode != null">DEVC_MODL_CD,</if>
            <if test="rKey != null">R_KEY,</if>
            <if test="psYn != null">PS_YN,</if>
            <if test="prId != null">PR_ID,</if>
            <if test="dvNm != null">DV_NM,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">#{deviceId},</if>
            <if test="serialNumber != null">#{serialNumber},</if>
            <if test="modelCode != null">#{modelCode},</if>
            <if test="rKey != null">#{rKey},</if>
            <if test="psYn != null">#{psYn},</if>
            <if test="prId != null">#{prId},</if>
            <if test="dvNm != null">#{dvNm},</if>
   
        </trim>
    </insert>

    <delete id="deleteExistPrId" parameterType="String">
        DELETE FROM 
            TBR_OPR_VALVE_BOX_STATUS 
        WHERE 
            PR_ID LIKE CONCAT('%', #{deviceId} , '%')
    </delete>

    <update id="updateEachRoomStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_VALVE_BOX_STATUS
                SET
                    <if test="deviceId != null">SUB_ID = #{deviceId},</if>
                    <if test="rKey != null">R_KEY = #{rKey},</if>
                    <if test="serialNumber != null">SERIAL_NO = #{serialNumber},</if>
                    <if test="prId != null">PR_ID = #{prId},</if>
                    <if test="psYn != null">PS_YN = #{psYn},</if>
                    <if test="dvNm != null">DV_NM = #{dvNm},</if>
                    <if test="modelCode != null">DEVC_MODL_CD = #{modelCode},</if>
                    <if test="powr != null">POWR = #{powr},</if>
                    <if test="opMd != null">OPMD = #{opMd},</if>
                    <if test="htTp != null">HTTP = #{htTp},</if>
                    <if test="hwTp != null">HWTP = #{hwTp},</if>
                    <if test="chTp != null">CHTP = #{chTp},</if>
                    <if test="cwTp != null">CWTP = #{cwTp},</if>
                    <if test="bCdt != null">BCDT = #{bCdt},</if>
                    <if test="hwSt != null">HWST = #{hwSt},</if>
                    <if test="h12 != null">12H = #{h12},</if>
                    MFDT = now()
            WHERE
                SUB_ID LIKE CONCAT('%', #{targetDeviceId}, '%') 
    </update>

    <update id="updateEachRoomControlStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_VALVE_BOX_STATUS
                SET
                    <if test="deviceId != null">SUB_ID = #{deviceId},</if>
                    <if test="rKey != null">R_KEY = #{rKey},</if>
                    <if test="serialNumber != null">SERIAL_NO = #{serialNumber},</if>
                    <if test="prId != null">PR_ID = #{prId},</if>
                    <if test="psYn != null">PS_YN = #{psYn},</if>
                    <if test="dvNm != null">DV_NM = #{dvNm},</if>
                    <if test="modelCode != null">DEVC_MODL_CD = #{modelCode},</if>
                    <if test="powr != null">POWR = #{powr},</if>
                    <if test="powr == null">POWR = 'on',</if>
                    <if test="opMd != null">OPMD = #{opMd},</if>
                    <if test="htTp != null">HTTP = #{htTp},</if>
                    <if test="hwTp != null">HWTP = #{hwTp},</if>
                    <if test="chTp != null">CHTP = #{chTp},</if>
                    <if test="cwTp != null">CWTP = #{cwTp},</if>
                    <if test="bCdt != null">BCDT = #{bCdt},</if>
                    <if test="hwSt != null">HWST = #{hwSt},</if>
                    <if test="h12 != null">12H = #{h12},</if>
                    MFDT = now()
            WHERE
                SUB_ID = #{deviceId}
    </update>

    <update id="updateEachRoomControlStatusHwTp" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_VALVE_BOX_STATUS
                SET
                    HWTP = #{hwTp},
                    MFDT = now()
            WHERE
                PR_ID = #{deviceId}
    </update>

    <insert id="insertDeviceStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        INSERT INTO TBR_OPR_DEVICE_STATUS
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">DEVC_ID,</if>
            <if test="serialNumber != null">SERIAL_NO,</if>
            <if test="rKey != null">R_KEY,</if>
            <if test="powr != null">POWR,</if>
            <if test="opMd != null">OPMD,</if>
            <if test="htTp != null">HTTP,</if>
            <if test="wtTp != null">WTTP,</if>
            <if test="hwTp != null">HWTP,</if>
            <if test="ftMd != null">FTMD,</if>
            <if test="bCdt != null">BCDT,</if>
            <if test="chTp != null">CHTP,</if>
            <if test="cwTp != null">CWTP,</if>
            <if test="hwSt != null">HWST,</if>
            <if test="slCd != null">SLCD,</if>
            <if test="mfDt != null">MFDT,</if>
            <if test="h12 != null">12H,</if>
            <if test="h24 != null">24H,</if>
            <if test="wk7 != null">7WK,</if>
            <if test="fwh != null">FWH,</if>
            <if test="fcLc != null">FCLC,</if>
            <if test="blCf != null">BLCF,</if>

            <if test="rsSl != null">RSSL,</if>
            <if test="rsPw != null">RSPW,</if>
            <if test="inAq != null">INAQ,</if>
            <if test="ven7Wk != null">7WK,</if>
            <if test="vtSp != null">VTSP,</if>
            <if test="vfLs != null">VFLS,</if>
            <if test="odHm != null">ODHM,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">#{deviceId},</if>
            <if test="serialNumber != null">#{serialNumber},</if>
            <if test="rKey != null">#{rKey},</if>
            <if test="powr != null">#{powr},</if>
            <if test="opMd != null">#{opMd},</if>
            <if test="htTp != null">#{htTp},</if>
            <if test="wtTp != null">#{wtTp},</if>
            <if test="hwTp != null">#{hwTp},</if>
            <if test="ftMd != null">#{ftMd},</if>
            <if test="bCdt != null">#{bCdt},</if>
            <if test="chTp != null">#{chTp},</if>
            <if test="cwTp != null">#{cwTp},</if>
            <if test="hwSt != null">#{hwSt},</if>
            <if test="slCd != null">#{slCd},</if>
            <if test="mfDt != null">now(),</if>
            <if test="h12 != null">#{h12},</if>
            <if test="h24 != null">#{h24},</if>
            <if test="wk7 != null">#{wk7},</if>
            <if test="fwh != null">#{fwh},</if>
            <if test="fcLc != null">#{fcLc},</if>
            <if test="blCf != null">#{blCf},</if>

            <if test="rsSl != null">#{rsSl},</if>
            <if test="rsPw != null">#{rsPw},</if>
            <if test="inAq != null">#{inAq},</if>
            <if test="ven7Wk != null">#{ven7Wk},</if>
            <if test="vtSp != null">#{vtSp},</if>
            <if test="vfLs != null">#{vfLs},</if>
            <if test="odHm != null">#{odHm},</if>
        </trim>
    </insert>

    <insert id="insertActiveStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        INSERT INTO TBR_OPR_ACTIVE_DEVICE_STATUS
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">DEVC_ID,</if>
            <if test="serialNumber != null">SERIAL_NO,</if>
            <if test="ftMdActv != null">FTMD,</if>
            <if test="fcLcActv != null">FCLC,</if>
            <if test="ecOpActv != null">ECOP,</if>
            <if test="past != null">PAST,</if>
            <if test="inDr != null">INDR,</if>
            <if test="inCl != null">INCL,</if>
            <if test="ecSt != null">ECST,</if>
            <if test="mfDt != null">MFDT,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deviceId != null">#{deviceId},</if>
            <if test="serialNumber != null">#{serialNumber},</if>
            <if test="ftMdActv != null">#{ftMdActv},</if>
            <if test="fcLcActv != null">#{fcLcActv},</if>
            <if test="ecOpActv != null">#{ecOpActv},</if>
            <if test="past != null">#{past},</if>
            <if test="inDr != null">#{inDr},</if>
            <if test="inCl != null">#{inCl},</if>
            <if test="ecSt != null">#{ecSt},</if>
            <if test="mfDt != null">now(),</if>
        </trim>
    </insert>

    <update id="updateDeviceStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_DEVICE_STATUS
                SET
                    SERIAL_NO = #{serialNumber},
                    R_KEY = #{rKey},
                    POWR = #{powr},
                    OPMD = #{opMd} ,
                    HTTP = #{htTp},
                    WTTP = #{wtTp},
                    HWTP = #{hwTp},
                    FTMD = #{ftMd},
                    BCDT = #{bCdt},
                    CHTP = #{chTp},
                    CWTP = #{cwTp},
                    HWST = #{hwSt},
                    7WK = #{wk7},
                    12H = #{h12},
                    24H = #{h24},
                    <if test="fwh != null">FWH = #{fwh},</if>
                    <if test="fcLc != null">FCLC = #{fcLc},</if>
                    <if test="blCf != null">BLCF = #{blCf},</if>
                    SLCD = #{slCd},
                    VTSP = #{vtSp},
                    VFLS = #{vfLs},
                    <if test="rsSl != null">RSSL = #{rsSl},</if>
                    <if test="rsPw != null">RSPW = #{rsPw},</if>
                    <if test="odHm != null">ODHM = #{odHm},</if>
                    INAQ = #{inAq},
                    MFDT = now()
            WHERE
                DEVC_ID = #{deviceId}
    </update>

    <update id="updateActiveStatus" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_ACTIVE_DEVICE_STATUS
        SET
            <if test="serialNumber != null">SERIAL_NO = #{serialNumber},</if>
            <if test="ftMdActv != null">FTMD = #{ftMdActv},</if>
            <if test="fcLcActv != null">FCLC = #{fcLcActv},</if>
            <if test="ecOpActv != null">ECOP = #{ecOpActv},</if>
            <if test="past != null">PAST = #{past},</if>
            <if test="inDr != null">INDR = #{inDr},</if>
            <if test="inCl != null">INCL = #{inCl},</if>
            <if test="ecSt != null">ECST = #{ecSt},</if>
            MFDT = now()
        WHERE
            DEVC_ID = #{deviceId}
    </update>

    <update id="updateDeviceStatusFromApplication" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE TBR_OPR_DEVICE_STATUS
        <set>
            <if test="serialNumber != null">SERIAL_NO = #{serialNumber},</if>
            <if test="rKey != null">R_KEY = #{rKey},</if>
            <if test="powr != null">POWR = #{powr},</if>
            <if test="powr eq 'on'">DVST = '1',</if>
            <if test="opMd != null">OPMD = #{opMd},</if>
            <if test="htTp != null">HTTP = #{htTp},</if>
            <if test="wtTp != null">WTTP = #{wtTp},</if>
            <if test="hwTp != null">HWTP = #{hwTp},</if>
            <if test="ftMd != null">FTMD = #{ftMd},</if>
            <if test="bCdt != null">BCDT = #{bCdt},</if>
            <if test="chTp != null">CHTP = #{chTp},</if>
            <if test="cwTp != null">CWTP = #{cwTp},</if>
            <if test="hwSt != null">HWST = #{hwSt},</if>
            <if test="blCf != null">BLCF = #{blCf},</if>
            <if test="wk7 != null">7WK = #{wk7},</if>
            <if test="mn != null">MN = #{mn},</if>
            <if test="h12 != null">12H = #{h12},</if>
            <if test="h24 != null">24H = #{h24},</if>
            <if test="fwh != null">FWH = #{fwh},</if>
            <if test="slCd != null">SLCD = #{slCd},</if>
            <if test="ecOp != null">ECOP = #{ecOp},</if>
            <if test="fcLc != null">FCLC = #{fcLc},</if>
            <if test="vtSp != null">VTSP = #{vtSp},</if>
            <if test="rsPw != null">RSPW = #{rsPw},</if>
            MFDT = now(),
        </set>
        WHERE DEVC_ID = #{deviceId}
    </update>

    <select id="getDeviceNickNameBySubId" parameterType="String" resultMap="dr910w">
        SELECT
            DV_NM AS deviceNickName,
            PR_ID AS deviceId
        FROM
            TBR_OPR_VALVE_BOX_STATUS
        WHERE
            SUB_ID = #{deviceId}
    </select>

    <select id="getEachRoomStautsByDeviceId" parameterType="String" resultMap="dr910w">
        SELECT
            SUB_ID AS deviceId
        FROM
            TBR_OPR_VALVE_BOX_STATUS
        WHERE
            SUB_ID LIKE CONCAT('%', #{deviceId}, '%') 
    </select>

    <select id="getDeviceStautsByDeviceId" parameterType="String" resultMap="dr910w">
        SELECT
            DEVC_ID AS deviceId
        FROM
            TBR_OPR_DEVICE_STATUS
        WHERE
            DEVC_ID = #{deviceId};
    </select>

    <select id="getActiveStautsByDeviceId" parameterType="String" resultMap="dr910w">
        SELECT
            DEVC_ID AS deviceId
        FROM
            TBR_OPR_ACTIVE_DEVICE_STATUS
        WHERE
            DEVC_ID = #{deviceId};
    </select>

    <insert id="insertUserDevice" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        INSERT INTO
            TBR_OPR_USER_DEVICE
        (
            USER_ID,
            DEVC_ID,
            DEVC_CTRL_KEY,
            ATTC_DATM,
            REG_DATM,
            GRP_IDX
        )
            VALUES
        (
            #{userId},
            #{deviceId},
            #{controlAuthKey},
            now(),
            now(),
            #{idx}
        )
    </insert>

    <update id="updateUserDevice" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE
            TBR_OPR_USER_DEVICE
        SET
            DEVC_CTRL_KEY = #{controlAuthKey}
        WHERE
            USER_ID = #{userId}
        AND
            DEVC_ID = #{deviceId}
    </update>

    <select id="getPushinfoByDeviceId" parameterType="String" resultMap="device">
        SELECT
            a.USER_ID AS userId,
            a.DEVC_ID AS deviceId,
            MAX(a.PUSH_YN_02) AS sPushYn,
            MAX(b.PUSH_TOKEN) AS pushToken -- PUSH_TOKEN의 중복을 제거
        FROM
            TBR_OPR_USER_DEVICE_PUSH a
        INNER JOIN
            TBR_OPR_ACCOUNT b ON a.USER_ID = b.USER_ID
        WHERE
            a.DEVC_ID = #{deviceId}
        GROUP BY
            a.USER_ID, a.DEVC_ID;
    </select>

    <select id="getDeviceStauts" parameterType="java.util.List" resultMap="dr910w">
        SELECT
            IFNULL(DEVC_ID, '') AS deviceId,
            IFNULL(SERIAL_NO, '') AS serialNumber,
            IFNULL(R_KEY, 0) AS rKey,
            IFNULL(POWR, '') AS powr,
            IFNULL(OPMD, 0) AS opMd,
            IFNULL(HTTP, 0.0) AS htTp,
            IFNULL(WTTP, 0.0) AS wtTp,
            IFNULL(HWTP, 0.0) AS hwTp,
            IFNULL(FTMD, '') AS ftMd,
            IFNULL(CHTP, 0.0) AS chTp,
            IFNULL(12H, '') AS h12,
            IFNULL(24H, '') AS h24,
            IFNULL(7WK, '') AS wk7,
            IFNULL(FWH, '') AS fwh,
            IFNULL(HWST, '') AS hwSt,
            IFNULL(FCLC, '') AS fcLc,
            IFNULL(MFDT, '') AS mfDt,
            IFNULL(SLCD, '') AS slCd,
            IFNULL(BCDT, '') AS bCdt,
            IFNULL(MN, '') AS mn,
            IFNULL(CWTP, 0.0) AS cwTp,
            IFNULL(BLCF, 0.0) AS blCf,
            IFNULL(VTSP, 0.0) AS vtSp,
            IFNULL(RSSL, 0.0) AS rsSl,
            IFNULL(RSPW, 0.0) AS rsPw,
            IFNULL(INAQ, 0.0) AS inAq,
            IFNULL(BLCF, 0.0) AS blCf,
            IFNULL(ODHM, 0.0) AS odHm
        FROM
            TBR_OPR_DEVICE_STATUS
        WHERE
            SERIAL_NO IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getActiveStauts" parameterType="java.util.List" resultMap="dr910w">
        SELECT
            IFNULL(DEVC_ID, '') AS deviceId,
            IFNULL(SERIAL_NO, '') AS serialNumber,
            IFNULL(FTMD, '') AS ftMd,
            IFNULL(FCLC, '') AS fcLc,
            IFNULL(ECOP, '') AS ecOp,
            IFNULL(PAST, '') AS past,
            IFNULL(INDR, '') AS inDr,
            IFNULL(INCL, '') AS inCl,
            IFNULL(ECST, '') AS ecSt,
            IFNULL(MFDT, '') AS mfDt
        FROM
            TBR_OPR_ACTIVE_DEVICE_STATUS
        WHERE
        SERIAL_NO IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getSingleDeviceStauts" parameterType="java.util.List" resultMap="dr910w">
        SELECT
            DEVC_ID AS deviceId,
            SERIAL_NO AS serialNumber,
            R_KEY AS rKey,
            POWR AS powr,
            OPMD AS opMd,
            HTTP AS htTp,
            WTTP AS wtTp,
            HWTP AS hwTp,
            FTMD AS ftMd,
            CHTP AS chTp,
            12H AS h12,
            24H AS h24,
            7WK AS wk7,
            FWH AS fwh,
            HWST AS hwSt,
            FCLC AS fcLc,
            MFDT AS mfDt,
            SLCD AS slCd,
            BCDT AS bCdt,
            CWTP AS cwTp
        FROM
            TBR_OPR_DEVICE_STATUS
        WHERE
            DEVC_ID = #{deviceId}
    </select>

    <insert id="insertErrorInfo" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_IOT_ERROR_COLEC
        (
            ERROR_NM,
            ERROR_CODE,
            REG_DATM,
            KEEP_CYCLE,
            SERIAL_NO,
            LAST_ERROR_DATM
        )
        VALUES
        (
            #{errorMessage},
            #{errorCode},
            now(),
            6,
            #{serialNumber},
            #{errorDateTime}
        )
    </insert>

    <select id="getDeviceErroInfo" parameterType="String" resultMap="device">
        SELECT
            ERROR_NM AS errorMessage,
            ERROR_CODE AS errorCode,
            LAST_ERROR_DATM AS errorDateTime,
            SERIAL_NO AS serialNumber
        FROM
            TBR_IOT_ERROR_COLEC
        WHERE
            SERIAL_NO = #{serialNumber}
    </select>

    <insert id="insertJson" parameterType="String">
        INSERT INTO
            GW_TEST_TABLE
        (
            JSONBODY
        )
        VALUES
        (
            #{jsonbody}
        )
    </insert>

    <select id="getDeviceRegistStatus" parameterType="String" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBR_IOT_DEVICE
        WHERE
            SERIAL_NO = #{serialNumber}
    </select>

    <update id="updateDeviceErrorStatus" parameterType="String">
        UPDATE
            TBR_OPR_DEVICE_STATUS
        SET
            DVST = '2'
        WHERE DEVC_ID = #{deviceId}
    </update>

    <select id="checkDeviceStatus" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            DEVC_ID AS deviceId
        FROM
            TBR_OPR_DEVICE_STATUS
        WHERE
            DEVC_ID = #{deviceId}
        AND
            R_KEY = #{controlAuthKey}
    </select>

    <select id="checkValveStatus" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBR_OPR_VALVE_BOX_STATUS
        WHERE
            PR_ID = #{deviceId}
        AND
            R_KEY = #{controlAuthKey}
    </select>

    <update id="updateSleepMode" parameterType="com.oauth.dto.gw.DeviceStatusInfo">
        UPDATE TBR_OPR_VENTI_DEVICE_STATUS
        <set>
            <if test="serialNumber != null">SERIAL_NO = #{serialNumber},</if>
            <if test="rKey != null">R_KEY = #{rKey},</if>
            <if test="powr != null">POWR = #{powr},</if>
            <if test="powr eq 'on'">DVST = '1',</if>
            <if test="opMd != null">OPMD = #{opMd},</if>
            <if test="vtSp != null">VTSP = #{vtSp},</if>
            <if test="onHour != null">ONHOUR = #{onHour},</if>
            <if test="onMinute != null">ONMINUTE = #{onMinute},</if>
            <if test="offHour != null">OFFHOUR = #{offHour},</if>
            <if test="offMinute != null">OFFMINUTE = #{offMinute},</if>
            <if test="pw != null">PW = #{pw},</if>
            <if test="hr != null">HR = #{hr},</if>
            <if test="mn != null">MN = #{mn},</if>
            <if test="ven7Wk != null">7WK = #{ven7Wk},</if>
            <if test="mfDt != null">MFDT = #{mfDt},</if>
        </set>
        WHERE
            DEVC_ID = #{deviceId}
    </update>

    <select id="checkDeviceAuthkeyExist" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        SELECT
            COALESCE(b.DEVC_CTRL_KEY, 'EMPTY') AS controlAuthKey
        FROM
            TBR_OPR_DEVICE_DETAIL a
        LEFT JOIN
            TBR_OPR_USER_DEVICE b
        ON
            b.USER_ID = #{userId}
        WHERE
            b.DEVC_ID = #{deviceId}
        AND
            b.USER_ID = #{userId}
        UNION ALL
        SELECT 'EMPTY' AS controlAuthKey
        WHERE NOT EXISTS (
        SELECT 1
        FROM
            TBR_OPR_DEVICE_DETAIL a
        INNER JOIN
            TBR_OPR_USER_DEVICE b
        ON
            b.USER_ID = #{userId}
        WHERE
            b.DEVC_ID = #{deviceId}
        AND
            b.USER_ID = #{userId}
        )
        LIMIT 1;
    </select>

    <insert id="insertFristDeviceUser" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_FIRST_DEVICE_USER
        (
            DEVC_ID,
            USER_ID,
            GRP_ID
        )
            VALUES
        (
            #{deviceId},
            #{userId},
            #{groupId}
        )
    </insert>

    <select id="checkDeviceExist" parameterType="String" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBR_OPR_DEVICE_DETAIL
        WHERE
            DEVC_ID = #{deviceId}
    </select>

    <select id="checkDeviceUserId" parameterType="String" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            USER_ID = #{userId}
        AND
            DEVC_ID = #{deviceId}
    </select>

    <select id="getCheckedDeviceExist" parameterType="String" resultMap="device">
        SELECT
            a.DEVC_ID AS deviceId,
            a.DEVC_CTRL_KEY AS controlAuthKey,
            b.USER_ID AS userId
        FROM
            TBR_OPR_DEVICE_DETAIL a
        INNER JOIN
            TBT_OPR_DEVICE_REGIST b
        ON
            a.DEVC_ID = b.DEVC_ID
        WHERE
            a.DEVC_ID = #{deviceId}
    </select>

    <select id="getInviteGroupIdxList" parameterType="String" resultMap="String">
        SELECT DISTINCT
            GRP_IDX AS groupIdx
        FROM
            TBD_USER_INVITE_GROUP
    </select>

    <select id="getRegistGroupIdxList" parameterType="String" resultMap="String">
        SELECT DISTINCT
            GRP_IDX AS groupIdx
        FROM
            TBT_OPR_DEVICE_REGIST
    </select>

    <select id="getDeviceIdByGroupIdx" parameterType="String" resultMap="device">
        SELECT
            DEVC_ID AS deviceId
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            GRP_IDX = #{groupIdx}
    </select>

    <delete id="deleteNoDeviceGroupByList" parameterType="list">
        DELETE FROM
            TBD_USER_INVITE_GROUP
        WHERE
            GRP_IDX  IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="getGroupNameAndDeviceNickByDeviceId" parameterType="String" resultMap="device">
        SELECT
            GRP_NM AS groupName,
            DEVC_NICK AS deviceNickname,
            GRP_IDX AS groupIdx
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            DEVC_ID = #{deviceId}
    </select>

    <select id="getDeviceIdByDeviceModelCode" parameterType="String" resultMap="String">
        SELECT
            DEVC_ID AS deviceId
        FROM
            TBR_IOT_DEVICE
        WHERE
            DEVC_MODL_CD = 'ESCeco13S'
    </select>

    <select id="getDeviceNicknameByDeviceId" parameterType="String" resultMap="device">
        SELECT
            DEVC_NICK AS deviceNickname
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            DEVC_ID =  #{deviceId}
    </select>

    <insert id="insertVentAirInfo" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_OPR_VENT_AIR_INFO
        (
            REG_DATM,
            DEVC_ID,
            PM25,
            CO2,
            PM10,
            OUT_DOOR_TEMP,
            OUT_DOOR_HUMI
        )
        VALUES
        (
            now(),
            #{deviceId},
            #{pm25},
            #{co2},
            #{pm10},
            #{indoorTemp},
            #{indoorHumi}
        )
    </insert>

    <select id="getVentilationAirInfoDaily" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        WITH RECURSIVE hours AS (
            SELECT 1 AS timeInfo
            UNION ALL
            SELECT
                timeInfo + 1
            FROM
                hours
            WHERE
                timeInfo &lt; 24
        )
        SELECT
            CASE
                WHEN
                    h.timeInfo = 24
                THEN
                    CONCAT(#{startDate}, '24:00:00')
                ELSE
                    DATE_FORMAT(STR_TO_DATE(CONCAT(#{startDate}, LPAD(h.timeInfo, 2, '0'), ':00:00'), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
            END AS workDate,
            COALESCE(CEIL(AVG(P.PM25)), 0) AS pm25,
            COALESCE(CEIL(AVG(P.CO2)), 0) AS co2,
            COALESCE(CEIL(AVG(P.PM10)), 0) AS pm10,
            COALESCE(CEIL(AVG(P.OUT_DOOR_TEMP)), 0) AS indoorTemp,
            COALESCE(CEIL(AVG(P.OUT_DOOR_HUMI)), 0) AS indoorHumi,
            h.timeInfo
            FROM
                hours h
            LEFT JOIN
                TBR_OPR_VENT_AIR_INFO P
            ON
                HOUR(P.REG_DATM) = h.timeInfo
            AND
                DATE(P.REG_DATM)
            BETWEEN
                #{startDate}
            AND
                #{endDate}
            AND
                P.DEVC_ID = #{deviceId}
            GROUP BY
                h.timeInfo, workDate
            ORDER BY
                h.timeInfo
    </select>

    <select id="getVentilationAirInfoMonthly" parameterType="com.oauth.dto.AuthServerDTO" resultMap="device">
        WITH RECURSIVE dates AS (
            SELECT
                DATE(#{startDate}) AS workDate
            UNION ALL
            SELECT
                workDate + INTERVAL 1 DAY
            FROM
                dates
            WHERE
                workDate &lt; #{endDate}
        )
        SELECT
            d.workDate,
            COALESCE(CEIL(AVG(t.PM25)), 0) AS pm25,
            COALESCE(CEIL(AVG(t.CO2)), 0) AS co2,
            COALESCE(CEIL(AVG(t.PM10)), 0) AS pm10,
            COALESCE(CEIL(AVG(t.OUT_DOOR_TEMP)), 0) AS indoorTemp,
            COALESCE(CEIL(AVG(t.OUT_DOOR_HUMI)), 0) AS indoorHumi
        FROM
            dates d
        LEFT JOIN
            TBR_OPR_VENT_AIR_INFO t
        ON
            DATE(t.REG_DATM) = d.workDate
        AND
            t.DEVC_ID = #{deviceId}
        GROUP BY
            d.workDate
        ORDER BY
            d.workDate
    </select>

    <select id="getDeviceIdFromVentilationAirInfo" parameterType="String" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBR_OPR_VENT_AIR_INFO
        WHERE
            DEVC_ID =  #{deviceId}
    </select>

    <select id="getSerialNumberAndModelCodeFromEachRoomInfo" parameterType="String" resultMap="device">
        SELECT 
            SERIAL_NO AS serialNumber,
            DEVC_MODL_CD AS modelCode,
            PR_ID AS parentDevice
        FROM 
	        TBR_OPR_VALVE_BOX_STATUS
        WHERE 
	        SERIAL_NO LIKE CONCAT('%', #{serialNumber}, '%')
    </select>

    <select id="getParentIdByUserId" parameterType="String" resultMap="device">
        SELECT 
            a.GRP_IDX AS groupIdx,
            a.GRP_NM AS groupName,
            a.DEVC_ID AS parentDevice,
            a.LAT AS latitude,
            a.LON AS longitude,
            a.DEVC_NICK AS deviceNickname,
            a.TEMP_DEVC_REG_KEY AS tmpRegistKey,
            b.DEVC_CTRL_KEY AS controlAuthKey
        FROM 
            TBT_OPR_DEVICE_REGIST a
        INNER JOIN
            TBR_OPR_DEVICE_DETAIL b
        ON
            a.DEVC_ID = b.DEVC_ID
        WHERE 
            a.DEVC_ID =  #{parentDevice}
    </select>

    <select id="getValveStatusByParentId" parameterType="String" resultMap="dr910w">
        SELECT 
            SUB_ID AS deviceId,
            POWR AS powr,
            OPMD AS opMd,
            HTTP AS htTp,
            HWTP AS hwTp,
            CHTP AS chTp,
            12H AS h12,
            MFDT AS mfDt,
            DV_NM AS deviceNickName
        FROM 
            TBR_OPR_VALVE_BOX_STATUS
        WHERE 
            PR_ID =  #{parentDevice}
    </select>

    <select id="getDetailedValveStatus" parameterType="String" resultMap="dr910w">
        SELECT 
            POWR AS powr,
            OPMD AS opMd,
            HTTP AS htTp,
            HWTP AS hwTp,
            CHTP AS chTp, 
            DVST AS dvSt,
            SUB_ID AS deviceId,
            R_KEY AS controlAuthKey,
            DV_NM AS deviceNickName
        FROM 
            TBR_OPR_VALVE_BOX_STATUS 
        WHERE 
            PR_ID = #{deviceId}
    </select>

    <select id="getParentIdBySubId" parameterType="String" resultMap="device">
        SELECT 
            PR_ID AS parentDevice
        FROM 
            TBR_OPR_VALVE_BOX_STATUS 
        WHERE 
            SUB_ID = #{deviceId}
    </select>

    <select id="getSingleSerialNumberBySubDeviceId" parameterType="String" resultMap="device">
        SELECT
            SERIAL_NO AS serialNumber
        FROM
            TBR_OPR_VALVE_BOX_STATUS
        WHERE
            SUB_ID = #{deviceId}
    </select>

    <select id="getSubIdByParentId" parameterType="String" resultMap="device">
        SELECT 
            SUB_ID AS deviceId,
            SERIAL_NO AS serialNumber,
            R_KEY AS controlAuthKey,
            DEVC_MODL_CD AS modelCode
        FROM 
            TBR_OPR_VALVE_BOX_STATUS
        WHERE
            PR_ID = #{deviceId} 
    </select>

    <select id="getGroupIdByUserId" parameterType="String" resultMap="device">
        SELECT DISTINCT
            GRP_ID AS groupId,
            GRP_NM AS groupName,
            GRP_IDX AS groupIdx
        FROM 
            TBD_USER_INVITE_GROUP
        WHERE
            USER_ID = #{userId} 
    </select>

    <select id="getDeviceStatusInfo" parameterType="String" resultMap="dr910w">
        SELECT 
            a.DEVC_NICK AS deviceNickName,
            a.GRP_IDX AS groupIdx,
            a.GRP_NM AS groupName,
            a.TEMP_DEVC_REG_KEY AS tmpRegistKey,
            a.LAT AS latitude,
            a.LON AS longitude,
            b.DVST AS dvSt,
            IFNULL(b.DEVC_ID, '') AS deviceId,
            IFNULL(b.SERIAL_NO, '') AS serialNumber,
            IFNULL(b.R_KEY, 0) AS rKey,
            IFNULL(b.POWR, '') AS powr,
            IFNULL(b.OPMD, 0) AS opMd,
            IFNULL(b.HTTP, 0.0) AS htTp,
            IFNULL(b.WTTP, 0.0) AS wtTp,
            IFNULL(b.HWTP, 0.0) AS hwTp,
            IFNULL(b.FTMD, '') AS ftMd,
            IFNULL(b.CHTP, 0.0) AS chTp,
            IFNULL(b.`12H`, '') AS h12,
            IFNULL(b.`24H`, '') AS h24,
            IFNULL(b.`7WK`, '') AS wk7,
            IFNULL(b.FWH, '') AS fwh,
            IFNULL(b.HWST, '') AS hwSt,
            IFNULL(b.FCLC, '') AS fcLc,
            IFNULL(b.SLCD, '') AS slCd,
            IFNULL(b.BCDT, '') AS bCdt,
            IFNULL(b.MN, '') AS mn,
            IFNULL(b.CWTP, 0.0) AS cwTp,
            IFNULL(b.BLCF, 0.0) AS blCf,
            IFNULL(b.VTSP, 0) AS vtSp,
            IFNULL(b.RSSL, 0.0) AS rsSl,
            IFNULL(b.RSPW, 0.0) AS rsPw,
            IFNULL(b.INAQ, 0.0) AS inAq,
            IFNULL(b.BLCF, 0.0) AS blCf,
            IFNULL(b.ODHM, '[,]') AS odHm,
            IFNULL(c.FTMD, '') AS ftMdActv,
            IFNULL(c.FCLC, '') AS fcLcActv,
            IFNULL(c.ECOP, '') AS ecOp,
            IFNULL(c.PAST, '') AS past,
            IFNULL(c.INDR, '') AS inDr,
            IFNULL(c.INCL, '') AS inCl,
            IFNULL(c.ECST, '') AS ecSt,
            IFNULL(c.MFDT, '') AS mfDt
        FROM 
            TBT_OPR_DEVICE_REGIST a
        INNER JOIN 
            TBR_OPR_DEVICE_STATUS b
        ON 
            a.DEVC_ID = b.DEVC_ID
        INNER JOIN 
            TBR_OPR_ACTIVE_DEVICE_STATUS c
        ON 
            a.DEVC_ID = c.DEVC_ID
        WHERE 
            a.GRP_IDX = #{groupIdx}
        AND 
            a.VALVE_STATUS = 'N'
    </select>

    <insert id="insertActiveOldDevice" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_OPR_ACTIVE_DEVICE_STATUS
        (
            DEVC_ID,
            SERIAL_NO
        )
            VALUES
        (
            #{deviceId},
            #{serialNumber}
        )
    </insert>

    <delete id="deleteActiveOldDevice" parameterType="list">
        DELETE FROM
            TBR_OPR_ACTIVE_DEVICE_STATUS
        WHERE
           DEVC_ID = #{deviceId}
        AND
            SERIAL_NO = #{serialNumber}
    </delete>

    <insert id="insertEachRoomStatInfo" parameterType="com.oauth.dto.AuthServerDTO">
        INSERT INTO
            TBR_OPR_EACH_ROOM_MODE_INFO
        (
            REG_DATM,
            DEVC_ID,
            POWR,
            OPMD
        )
        VALUES
        (
            now(),
            #{deviceId},
            #{powr},
            #{opMd}
        )
    </insert>

    <select id="getSubAndParentDeviceInfo" parameterType="String" resultMap="dr910w">
        SELECT 
            a.SUB_ID AS subDevice,
            a.PR_ID AS parentDevice,
            a.DV_NM AS subDeviceNickname,
            b.DEVC_NICK AS parentDeviceNickname,
            a.POWR AS powr,
            a.OPMD AS opMd,
            a.HTTP AS htTp,
            a.HWTP AS hwTp,
            a.CHTP AS chTp
        FROM 
            TBR_OPR_VALVE_BOX_STATUS a
        INNER JOIN 
            TBT_OPR_DEVICE_REGIST b
        ON 
            a.PR_ID = b.DEVC_ID
        WHERE 
            SUB_ID = #{deviceId}
    </select>

    <select id="getErrorInfoByDeviceId" parameterType="String" resultMap="device">
        SELECT 
            DEVC_NICK AS deviceNickname,
            GRP_NM AS groupName,
            PUSH_CONTENT AS errorVersion,
            PUSH_TITLE AS errorCode,
            PUSH_DATETIME AS errorDatetime,
			GRP_NM AS groupName
        FROM 
            TBR_OPR_USER_DEVICE_PUSH_INFO a
        WHERE 
            DEVC_ID = #{deviceId}
        AND 
            PUSH_TYPE = '02'
        ORDER BY 
            PUSH_DATETIME DESC
        LIMIT 1
    </select>

    <select id="checkDeviceCount" parameterType="String" resultMap="device">
        SELECT
            COUNT(*) AS deviceCount
        FROM
            TBT_OPR_DEVICE_REGIST
        WHERE
            GRP_IDX = #{groupIdx}
    </select>
</mapper>